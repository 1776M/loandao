<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DAO-to-DAO Loan Dashboard (v3 - Proxy Fixed)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-bg': '#0f172a',
                        'secondary-bg': '#1e293b',
                        'card-bg': '#334155',
                        'accent': '#3b82f6',
                        'accent-hover': '#2563eb',
                        'success': '#10b981',
                        'error': '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-primary-bg min-h-screen flex items-start justify-center p-4 text-white">

    <div class="container bg-secondary-bg p-6 rounded-xl shadow-2xl max-w-lg w-full md:max-w-3xl">
        <h1 class="text-3xl font-bold mb-4 text-center text-accent">DAO-to-DAO Loan Dashboard</h1>
        
        <!-- Connection Status & Role -->
        <div id="status-container" class="mb-4 p-3 rounded-lg flex justify-between items-center bg-card-bg shadow-inner">
            <div id="connection-status" class="text-sm">
                <span class="text-yellow-400 font-semibold">Wallet: Disconnected</span>
            </div>
            <div id="role-display" class="text-sm font-bold">Role: Spectator</div>
            <button onclick="connectWallet()" class="bg-accent hover:bg-accent-hover text-white text-sm px-3 py-1 rounded-lg">Connect Wallet</button>
        </div>

        <!-- Transaction Status (Toast) -->
        <div id="tx-message" class="hidden mb-4 p-3 rounded-lg text-sm transition-all duration-300"></div>

        <div id="dashboard-content" class="space-y-6">

            <!-- Loan Overview -->
            <div class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Loan Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <p><strong>Principal:</strong> <span id="amount">--</span> USDC</p>
                    <p><strong>Annual Interest:</strong> <span id="interest">--</span>%</p>
                    <p><strong>Collateral:</strong> <span id="collateral">--</span> DAO Tokens</p>
                    <p><strong>Payments Made:</strong> <span id="payments-made">--</span> / 8</p>
                    <p><strong>Loan Status:</strong> <span id="loan-disbursed" class="font-semibold text-yellow-500">Pending</span></p>
                    <p><strong>Time Remaining:</strong> <span id="time-remaining">--</span></p>
                </div>
            </div>

            <!-- Party Details -->
            <div class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Party Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <p><strong>Borrower DAO:</strong> <span id="borrower-dao-owner" class="truncate">--</span></p>
                    <p><strong>Lender DAO:</strong> <span id="lender-dao-admin" class="truncate">--</span></p>
                    <p><strong>DAO Contract (B):</strong> <span id="borrower-dao-addr" class="truncate text-gray-400">--</span></p>
                    <p><strong>DAO Contract (L):</strong> <span id="lender-dao-addr" class="truncate text-gray-400">--</span></p>
                </div>
            </div>

            <!-- Action Buttons (Conditional Visibility) -->
            <div id="action-area" class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Actions</h2>
                <div class="flex flex-wrap gap-3" id="buttons-container">
                    <!-- Buttons will be rendered here based on role and status -->
                </div>
            </div>

            <!-- Balances (Always visible) -->
            <div class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Liquidity Snapshot</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <p><strong>Borrower USDC Balance:</strong> <span id="borrower-balance">--</span></p>
                    <p><strong>Lender USDC Balance:</strong> <span id="lender-balance">--</span></p>
                    <p><strong>Collateral Token Address:</strong> <span id="collateral-token-addr" class="truncate text-gray-400">--</span></p>
                    <p><strong>Loan USDC Allowance:</strong> <span id="usdc-allowance">--</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS AND GLOBALS ---
        // Make sure this is your latest DAOLoanContract deployment
        const loanAddress = "0x9932e0A5D9bc18d443ADe39c4c1c0bd0787A64Fd";

        const USDC_DECIMALS = 6;
        const COLLATERAL_DECIMALS = 18;
        
        // --- ABIS ---
        // 1. ERC20
        const erc20ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        // 2. LOAN CONTRACT
        const loanABI = [
            "function fundLoan() external",
            "function payInterest() external",
            "function repayPrincipal() external",
            "function claimCollateral() external",
            "function borrower() view returns (address)",
            "function lender() view returns (address)",
            "function principal() view returns (uint256)",
            "function interestRate() view returns (uint256)", 
            "function collateralAmount() view returns (uint256)",
            "function disbursed() view returns (bool)",
            "function paymentsMade() view returns (uint256)",
            "function startTime() view returns (uint256)",
            "function loanDuration() view returns (uint256)",
            "function quarterly() view returns (uint256)",
            "function usdc() view returns (address)",
            "function collateralToken() view returns (address)"
        ];

        // 3. BORROWER DAO ABI (with proxy functions)
        const borrowerDAOABI = [
            "function approveLoanCollateral(address loanContract, uint256 amount) external",
            "function owner() view returns (address)",
            "function approveToken(address token, address spender, uint256 amount) external",
            "function executeLoanAction(address loanContract, bytes calldata data) external"
        ];

        // 4. LENDER DAO ABI
        const lenderDAOABI = [
            "function admin() view returns (address)",
            "function executeLoan(address loanContract, bytes calldata data) external"
        ];

        let provider, signer, signerAddress;
        let loanContract, borrowerDAOContractInstance, lenderDAOContractInstance, usdcContractInstance;
        let loanData = {};
        
        // --- UTILITY FUNCTIONS ---
        const formatAddress = (addr) => `${addr.slice(0, 6)}...${addr.slice(-4)}`;
        const formatUnits = (value, decimals) => ethers.formatUnits(value, decimals);
        
        const setTxMessage = (message, type = 'info') => {
            const el = document.getElementById("tx-message");
            el.textContent = message;
            el.className = `mb-4 p-3 rounded-lg text-sm transition-all duration-300 ${type === 'success' ? 'bg-success/20 text-success' : type === 'error' ? 'bg-error/20 text-error' : 'bg-blue-400/20 text-blue-400'}`;
            el.classList.remove('hidden');
        };

        const timeRemaining = (startTime, duration, disbursed) => {
            if (!disbursed || startTime === 0n) return "N/A";
            const now = BigInt(Math.floor(Date.now() / 1000));
            const endTime = startTime + duration;
            if (now >= endTime) return "Expired (Repayment Due)";
            const remaining = endTime - now;
            const days = Number(remaining) / (60 * 60 * 24);
            return `${days.toFixed(0)} days left`;
        };

        // --- CORE FUNCTIONS ---

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                setTxMessage("MetaMask required.", 'error');
                return;
            }
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                signerAddress = await signer.getAddress(); // ethers v6

                document.getElementById("connection-status").innerHTML =
                    `<span class="text-success font-semibold">Wallet: ${formatAddress(signerAddress)}</span>`;

                // Initialize Loan contract
                loanContract = new ethers.Contract(loanAddress, loanABI, signer);

                await refreshStatus();
            } catch (error) {
                console.error("Connection failed:", error);
                setTxMessage(`Connection failed.`, 'error');
            }
        }

        async function refreshStatus() {
            if (!loanContract) return;
            setTxMessage("Fetching data...", 'info');
            
            try {
                // 1. Fetch Loan Data
                const [
                    borrowerDAOAddr, lenderDAOAddr, principal, interestRate, collateralAmount,
                    disbursed, paymentsMade, startTime, loanDuration, quarterly, usdcAddr, collateralTokenAddr
                ] = await Promise.all([
                    loanContract.borrower(),
                    loanContract.lender(),
                    loanContract.principal(),
                    loanContract.interestRate(),
                    loanContract.collateralAmount(),
                    loanContract.disbursed(),
                    loanContract.paymentsMade(),
                    loanContract.startTime(),
                    loanContract.loanDuration(),
                    loanContract.quarterly(),
                    loanContract.usdc(),
                    loanContract.collateralToken()
                ]);

                loanData = {
                    borrowerDAOAddr,
                    lenderDAOAddr,
                    principal,
                    interestRate,
                    collateralAmount,
                    disbursed,
                    paymentsMade: Number(paymentsMade),
                    startTime: Number(startTime),
                    loanDuration,
                    quarterly,
                    usdcAddr,
                    collateralTokenAddr
                };

                // 2. Initialize DAO Contracts (with signer)
                borrowerDAOContractInstance = new ethers.Contract(borrowerDAOAddr, borrowerDAOABI, signer);
                lenderDAOContractInstance   = new ethers.Contract(lenderDAOAddr, lenderDAOABI, signer);

                const [borrowerOwner, lenderAdmin] = await Promise.all([
                    borrowerDAOContractInstance.owner(),
                    lenderDAOContractInstance.admin()
                ]);
                
                loanData.borrowerOwner = borrowerOwner;
                loanData.lenderAdmin   = lenderAdmin;

                // 3. Determine Role
                let role = 'Spectator';
                if (signerAddress.toLowerCase() === borrowerOwner.toLowerCase()) role = 'Borrower Admin';
                else if (signerAddress.toLowerCase() === lenderAdmin.toLowerCase()) role = 'Lender Admin';
                loanData.role = role;

                // 4. Initialize token contracts & fetch balances / allowances
                usdcContractInstance = new ethers.Contract(usdcAddr, erc20ABI, signer);
                const collateralTokenContract = new ethers.Contract(collateralTokenAddr, erc20ABI, signer);

                const [
                    borrowerBalance,
                    lenderBalance,
                    usdcAllowance,
                    collateralAllowance
                ] = await Promise.all([
                    usdcContractInstance.balanceOf(borrowerDAOAddr),
                    usdcContractInstance.balanceOf(lenderDAOAddr),
                    usdcContractInstance.allowance(borrowerDAOAddr, loanAddress),
                    collateralTokenContract.allowance(borrowerDAOAddr, loanAddress)
                ]);

                loanData.borrowerBalance    = borrowerBalance;
                loanData.lenderBalance      = lenderBalance;
                loanData.usdcAllowance      = usdcAllowance;
                loanData.collateralAllowance = collateralAllowance;

                // 5. Update UI
                updateLoanDisplay();
                updateActionButtons();
                setTxMessage("Data refreshed.", 'success');

            } catch (error) {
                console.error("Error:", error);
                setTxMessage(`Error loading data. Check addresses.`, 'error');
            }
        }

        function updateLoanDisplay() {
            const roleEl = document.getElementById("role-display");
            roleEl.textContent = `Role: ${loanData.role}`;
            roleEl.className = `text-sm font-bold ${loanData.role.includes('Admin') ? 'text-accent' : 'text-gray-400'}`;

            document.getElementById("amount").textContent       = formatUnits(loanData.principal, USDC_DECIMALS);
            document.getElementById("interest").textContent     = (Number(loanData.interestRate) / 100).toFixed(2);
            document.getElementById("collateral").textContent   = Number(formatUnits(loanData.collateralAmount, COLLATERAL_DECIMALS)).toFixed(4);
            document.getElementById("payments-made").textContent = `${loanData.paymentsMade} / 8`;

            document.getElementById("loan-disbursed").textContent = loanData.disbursed ? 'Active' : 'Pending';
            document.getElementById("loan-disbursed").className   = loanData.disbursed
                ? 'font-semibold text-success'
                : 'font-semibold text-yellow-500';

            document.getElementById("time-remaining").textContent =
                timeRemaining(BigInt(loanData.startTime), loanData.loanDuration, loanData.disbursed);

            document.getElementById("borrower-dao-owner").textContent = formatAddress(loanData.borrowerOwner);
            document.getElementById("lender-dao-admin").textContent   = formatAddress(loanData.lenderAdmin);
            document.getElementById("borrower-dao-addr").textContent  = loanData.borrowerDAOAddr;
            document.getElementById("lender-dao-addr").textContent    = loanData.lenderDAOAddr;
            document.getElementById("collateral-token-addr").textContent = loanData.collateralTokenAddr;

            document.getElementById("borrower-balance").textContent =
                Number(formatUnits(loanData.borrowerBalance, USDC_DECIMALS)).toFixed(2) + " USDC";
            document.getElementById("lender-balance").textContent =
                Number(formatUnits(loanData.lenderBalance, USDC_DECIMALS)).toFixed(2) + " USDC";
            document.getElementById("usdc-allowance").textContent =
                Number(formatUnits(loanData.usdcAllowance, USDC_DECIMALS)).toFixed(2) + " USDC";
        }

        function updateActionButtons() {
            const container = document.getElementById('buttons-container');
            container.innerHTML = '';

            const role         = loanData.role;
            const disbursed    = loanData.disbursed;
            const paymentsMade = loanData.paymentsMade;
            const numPayments  = 8;

            // Collateral and USDC allowance checks
            const collateralApproved = loanData.collateralAllowance >= loanData.collateralAmount;
            const requiredUSDCAllowance = (loanData.principal * 150n) / 100n;
            const isUSDCApproved       = loanData.usdcAllowance >= requiredUSDCAllowance;

            const addButton = (text, onClick, isEnabled = true, colorClass = 'bg-accent hover:bg-accent-hover') => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.onclick = onClick;
                btn.className = `transition-all px-4 py-2 rounded-lg font-semibold text-sm shadow-lg w-full md:w-auto flex-grow ${
                    isEnabled ? colorClass : 'bg-gray-600 cursor-not-allowed'
                }`;
                if (!isEnabled) btn.disabled = true;
                container.appendChild(btn);
            };

            // Always show a Refresh button
            addButton('Refresh', refreshStatus, true, 'bg-gray-600 hover:bg-gray-500');

            if (role === 'Borrower Admin') {
                if (!disbursed) {
                    // Pre-Disbursement Flow
                    if (!collateralApproved) {
                        addButton('1. Approve Collateral', approveCollateral, true);
                    } else {
                        addButton('Collateral Approved', () => {}, false);
                    }

                    if (!isUSDCApproved) {
                        addButton('2. Approve USDC (Repayment)', approveUSDC, true);
                    } else {
                        addButton('USDC Approved', () => {}, false);
                    }
                } else {
                    // Post-Disbursement Flow
                    if (paymentsMade < numPayments) {
                        addButton(`Pay Q${paymentsMade + 1} Interest`, payInterest, true);
                    } else {
                        addButton('Repay Principal', repayPrincipal, true, 'bg-yellow-600 hover:bg-yellow-700');
                    }
                }
            }
            
            if (role === 'Lender Admin') {
                if (!disbursed) {
                    // Lender can only fund when collateral is approved
                    addButton('3. Fund Loan', fundLoan, collateralApproved);
                    if (!collateralApproved) {
                        addButton('Waiting on Collateral Approval', () => {}, false);
                    }
                } else {
                    if (timeRemaining(BigInt(loanData.startTime), loanData.loanDuration, true).includes("Expired")) {
                        addButton('Claim Collateral (Default)', claimCollateral, true, 'bg-red-600 hover:bg-red-700');
                    } else {
                        addButton('Loan Active', () => {}, false);
                    }
                }
            }
        }
        
        async function executeTransaction(txFunction, successMessage) {
            if (!signer) return setTxMessage("Connect wallet.", 'error');
            setTxMessage("Pending...", 'info');
            try {
                const tx = await txFunction();
                setTxMessage(`Submitted: ${formatAddress(tx.hash)}`, 'info');
                await tx.wait();
                setTxMessage(successMessage, 'success');
                await refreshStatus();
            } catch (error) {
                console.error(error);
                let msg = "Failed.";
                if (error.reason) msg = error.reason;
                else if (error.message && error.message.includes("user rejected")) msg = "User rejected.";
                else if (error.data) msg = "Revert (check console)";
                setTxMessage(msg, 'error');
            }
        }

        // --- TX WRAPPERS (PROXY CALLS) ---

        const approveCollateral = () => executeTransaction(() => {
            return borrowerDAOContractInstance.approveLoanCollateral(
                loanAddress,
                loanData.collateralAmount
            );
        }, "Collateral Approved!");

        const approveUSDC = () => executeTransaction(() => {
            const maxAllowance = (loanData.principal * 150n) / 100n;
            return borrowerDAOContractInstance.approveToken(
                loanData.usdcAddr,
                loanAddress,
                maxAllowance
            );
        }, "USDC Approved!");

        const fundLoan = () => executeTransaction(() => {
            const data = loanContract.interface.encodeFunctionData("fundLoan", []);
            return lenderDAOContractInstance.executeLoan(loanAddress, data);
        }, "Loan Funded!");

        const payInterest = () => executeTransaction(() => {
            const data = loanContract.interface.encodeFunctionData("payInterest", []);
            return borrowerDAOContractInstance.executeLoanAction(loanAddress, data);
        }, "Interest Paid!");

        const repayPrincipal = () => executeTransaction(() => {
            const data = loanContract.interface.encodeFunctionData("repayPrincipal", []);
            return borrowerDAOContractInstance.executeLoanAction(loanAddress, data);
        }, "Principal Repaid!");

        const claimCollateral = () => executeTransaction(() => {
            const data = loanContract.interface.encodeFunctionData("claimCollateral", []);
            return lenderDAOContractInstance.executeLoan(loanAddress, data);
        }, "Collateral Claimed!");

        window.onload = () => {
            if (window.ethereum) {
                connectWallet();
                window.ethereum.on('accountsChanged', connectWallet);
                window.ethereum.on('chainChanged', connectWallet);
            }
        };
    </script>
</body>
</html>
