<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DAO-to-DAO Loan Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-bg': '#0f172a',
                        'secondary-bg': '#1e293b',
                        'card-bg': '#334155',
                        'accent': '#3b82f6',
                        'accent-hover': '#2563eb',
                        'success': '#10b981',
                        'error': '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-primary-bg min-h-screen flex items-start justify-center p-4 text-white">

    <div class="container bg-secondary-bg p-6 rounded-xl shadow-2xl max-w-lg w-full md:max-w-4xl">
        <h1 class="text-3xl font-bold mb-4 text-center text-accent">DAO-to-DAO Loan Dashboard</h1>
        
        <!-- Connection Status & Role -->
        <div id="status-container" class="mb-4 p-3 rounded-lg flex justify-between items-center bg-card-bg shadow-inner">
            <div id="connection-status" class="text-sm">
                <span class="text-yellow-400 font-semibold">Wallet: Disconnected</span>
            </div>
            <div id="role-display" class="text-sm font-bold">Role: Spectator</div>
            <button onclick="connectWallet()" class="bg-accent hover:bg-accent-hover text-white text-sm px-3 py-1 rounded-lg">Connect Wallet</button>
        </div>

        <!-- Transaction Status (Toast) -->
        <div id="tx-message" class="hidden mb-4 p-3 rounded-lg text-sm transition-all duration-300"></div>

        <div id="dashboard-content" class="space-y-6">

            <!-- Loan Overview -->
            <div class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Loan Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <p><strong>Principal:</strong> <span id="amount">--</span> USDC</p>
                    <p><strong>Annual Interest:</strong> <span id="interest">--</span>%</p>
                    <p><strong>Collateral:</strong> <span id="collateral">--</span> DAO Tokens</p>
                    <p><strong>Payments Made:</strong> <span id="payments-made">--</span> </p>
                    <p><strong>Loan Status:</strong> <span id="loan-disbursed" class="font-semibold text-yellow-500">Pending</span></p>
                    <p><strong>Time Remaining:</strong> <span id="time-remaining">--</span></p>
                    <p class="col-span-full"><strong>Next Payment Due:</strong> <span id="next-payment-due">--</span></p>
                </div>
            </div>

            <!-- Party Details -->
            <div class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Party Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <p><strong>Borrower DAO Owner:</strong> <span id="borrower-dao-owner" class="truncate">--</span></p>
                    <p><strong>Lender DAO Admin:</strong> <span id="lender-dao-admin" class="truncate">--</span></p>
                    <p><strong>Borrower DAO Contract:</strong> <span id="borrower-dao-addr" class="truncate text-gray-400">--</span></p>
                    <p><strong>Lender DAO Contract:</strong> <span id="lender-dao-addr" class="truncate text-gray-400">--</span></p>
                </div>
            </div>

            <!-- Action Buttons (Conditional Visibility) -->
            <div id="action-area" class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Actions</h2>
                <div class="flex flex-wrap gap-3" id="buttons-container">
                    <!-- Buttons will be rendered here based on role and status -->
                </div>
            </div>

            <!-- Balances & Allowances -->
            <div class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Balances & Allowances</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <p><strong>Borrower DAO USDC:</strong> <span id="borrower-balance">--</span></p>
                    <p><strong>Lender DAO USDC:</strong> <span id="lender-balance">--</span></p>
                    <p><strong>Loan Contract USDC:</strong> <span id="loan-balance">--</span></p>
                    <p><strong>Borrower DAO Collateral:</strong> <span id="borrower-collateral-balance">--</span></p>
                    <p><strong>USDC Allowance (to Loan):</strong> <span id="usdc-allowance">--</span></p>
                    <p><strong>Collateral Allowance (to Loan):</strong> <span id="collateral-allowance">--</span></p>
                </div>
            </div>

            <!-- Contract Addresses -->
            <div class="p-5 bg-card-bg rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">Contract Addresses</h2>
                <div class="grid grid-cols-1 gap-2 text-xs font-mono">
                    <p><strong>USDC:</strong> <span id="usdc-addr" class="text-gray-400">--</span></p>
                    <p><strong>Collateral Token:</strong> <span id="collateral-token-addr" class="text-gray-400">--</span></p>
                    <p><strong>Loan Contract:</strong> <span id="loan-contract-addr" class="text-gray-400">--</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS AND GLOBALS ---
        const loanAddress = "0x38b1f2fc31931b6D5CaE226738f950452949DbeF"; 

        const USDC_DECIMALS = 18;
        const COLLATERAL_DECIMALS = 18;
        
        // --- ABIS ---
        const erc20ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const loanABI = [
            "function fundLoan() external",
            "function payInterest() external",
            "function repayPrincipal() external",
            "function claimCollateral() external",
            "function borrower() view returns (address)",
            "function lender() view returns (address)",
            "function principal() view returns (uint256)",
            "function interestRate() view returns (uint256)", 
            "function collateralAmount() view returns (uint256)",
            "function disbursed() view returns (bool)",
            "function paymentsMade() view returns (uint256)",
            "function startTime() view returns (uint256)",
            "function loanDuration() view returns (uint256)",
            "function quarterly() view returns (uint256)",
            "function usdc() view returns (address)",
            "function collateralToken() view returns (address)",
            "function numPayments() view returns (uint256)",
            "function principalRepaid() view returns (bool)"
        ];

        const borrowerDAOABI = [
            "function approveLoanCollateral(address loanContract, uint256 amount) external",
            "function owner() view returns (address)",
            "function approveToken(address token, address spender, uint256 amount) external",
            "function executeLoanAction(address loanContract, bytes calldata data) external"
        ];

        const lenderDAOABI = [
            "function admin() view returns (address)",
            "function executeLoan(address loanContract, bytes calldata data) external",
            "function transferTokens(address token, address to, uint256 amount) external"
        ];

        let provider, signer, signerAddress;
        let loanContract, borrowerDAOContractInstance, lenderDAOContractInstance, usdcContractInstance, collateralTokenContract;
        let loanData = {};
        
        // --- UTILITY FUNCTIONS ---
        const formatAddress = (addr) => `${addr.slice(0, 6)}...${addr.slice(-4)}`;
        const formatUnits = (value, decimals) => ethers.formatUnits(value, decimals);
        
        const setTxMessage = (message, type = 'info') => {
            const el = document.getElementById("tx-message");
            el.textContent = message;
            el.className = `mb-4 p-3 rounded-lg text-sm transition-all duration-300 ${type === 'success' ? 'bg-success/20 text-success' : type === 'error' ? 'bg-error/20 text-error' : 'bg-blue-400/20 text-blue-400'}`;
            el.classList.remove('hidden');
        };

        const timeRemaining = (startTime, duration, disbursed) => {
            if (!disbursed || startTime === 0n) return "N/A";
            const now = BigInt(Math.floor(Date.now() / 1000));
            const endTime = startTime + duration;
            if (now >= endTime) return "Expired (Repayment Due)";
            const remaining = endTime - now;
            const days = Number(remaining) / (60 * 60 * 24);
            const hours = Number(remaining) / (60 * 60);
            if (days >= 1) return `${days.toFixed(1)} days`;
            if (hours >= 1) return `${hours.toFixed(1)} hours`;
            return `${Math.floor(Number(remaining) / 60)} minutes`;
        };

        const nextPaymentDue = (startTime, quarterly, paymentsMade, numPayments, disbursed) => {
            if (!disbursed || paymentsMade >= numPayments) return "N/A";
            const now = BigInt(Math.floor(Date.now() / 1000));
            const nextDue = startTime + (quarterly * BigInt(paymentsMade + 1));
            if (now >= nextDue) return "Payment Overdue!";
            const remaining = nextDue - now;
            const days = Number(remaining) / (60 * 60 * 24);
            const hours = Number(remaining) / (60 * 60);
            if (days >= 1) return `${days.toFixed(1)} days`;
            if (hours >= 1) return `${hours.toFixed(1)} hours`;
            return `${Math.floor(Number(remaining) / 60)} minutes`;
        };

        // --- CORE FUNCTIONS ---

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                setTxMessage("MetaMask required.", 'error');
                return;
            }
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                signerAddress = await signer.getAddress();

                document.getElementById("connection-status").innerHTML =
                    `<span class="text-success font-semibold">Wallet: ${formatAddress(signerAddress)}</span>`;

                loanContract = new ethers.Contract(loanAddress, loanABI, signer);

                await refreshStatus();
            } catch (error) {
                console.error("Connection failed:", error);
                setTxMessage(`Connection failed.`, 'error');
            }
        }

        async function refreshStatus() {
            if (!loanContract) return;
            setTxMessage("Fetching data...", 'info');
            
            try {
                const [
                    borrowerDAOAddr, lenderDAOAddr, principal, interestRate, collateralAmount,
                    disbursed, paymentsMade, startTime, loanDuration, quarterly, usdcAddr, 
                    collateralTokenAddr, numPayments, principalRepaid
                ] = await Promise.all([
                    loanContract.borrower(),
                    loanContract.lender(),
                    loanContract.principal(),
                    loanContract.interestRate(),
                    loanContract.collateralAmount(),
                    loanContract.disbursed(),
                    loanContract.paymentsMade(),
                    loanContract.startTime(),
                    loanContract.loanDuration(),
                    loanContract.quarterly(),
                    loanContract.usdc(),
                    loanContract.collateralToken(),
                    loanContract.numPayments(),
                    loanContract.principalRepaid() 
                ]);

                loanData = {
                    borrowerDAOAddr,
                    lenderDAOAddr,
                    principal,
                    interestRate,
                    collateralAmount,
                    disbursed,
                    paymentsMade: Number(paymentsMade),
                    startTime: BigInt(startTime),
                    loanDuration,
                    quarterly,
                    usdcAddr,
                    collateralTokenAddr,
                    numPayments: Number(numPayments),
                    principalRepaid 
                };

                borrowerDAOContractInstance = new ethers.Contract(borrowerDAOAddr, borrowerDAOABI, signer);
                lenderDAOContractInstance   = new ethers.Contract(lenderDAOAddr, lenderDAOABI, signer);

                const [borrowerOwner, lenderAdmin] = await Promise.all([
                    borrowerDAOContractInstance.owner(),
                    lenderDAOContractInstance.admin()
                ]);
                
                loanData.borrowerOwner = borrowerOwner;
                loanData.lenderAdmin   = lenderAdmin;

                let role = 'Spectator';
                if (signerAddress.toLowerCase() === borrowerOwner.toLowerCase()) role = 'Borrower Admin';
                else if (signerAddress.toLowerCase() === lenderAdmin.toLowerCase()) role = 'Lender Admin';
                loanData.role = role;

                usdcContractInstance = new ethers.Contract(usdcAddr, erc20ABI, signer);
                collateralTokenContract = new ethers.Contract(collateralTokenAddr, erc20ABI, signer);

                const [
                    borrowerBalance,
                    lenderBalance,
                    loanBalance,
                    borrowerCollateralBalance,
                    usdcAllowance,
                    collateralAllowance,
                    lenderDAOBalance
                ] = await Promise.all([
                    usdcContractInstance.balanceOf(borrowerDAOAddr),
                    usdcContractInstance.balanceOf(lenderDAOAddr),
                    usdcContractInstance.balanceOf(loanAddress),
                    collateralTokenContract.balanceOf(borrowerDAOAddr),
                    usdcContractInstance.allowance(borrowerDAOAddr, loanAddress),
                    collateralTokenContract.allowance(borrowerDAOAddr, loanAddress),
                    usdcContractInstance.balanceOf(lenderDAOAddr)
                ]);

                loanData.borrowerBalance = borrowerBalance;
                loanData.lenderBalance = lenderBalance;
                loanData.loanBalance = loanBalance;
                loanData.borrowerCollateralBalance = borrowerCollateralBalance;
                loanData.usdcAllowance = usdcAllowance;
                loanData.collateralAllowance = collateralAllowance;
                loanData.lenderDAOBalance = lenderDAOBalance;

                updateLoanDisplay();
                updateActionButtons();
                setTxMessage("Data refreshed.", 'success');

            } catch (error) {
                console.error("Error:", error);
                setTxMessage(`Error loading data. Check addresses.`, 'error');
            }
        }

        function updateLoanDisplay() {
            const roleEl = document.getElementById("role-display");
            roleEl.textContent = `Role: ${loanData.role}`;
            roleEl.className = `text-sm font-bold ${loanData.role.includes('Admin') ? 'text-accent' : 'text-gray-400'}`;

            document.getElementById("amount").textContent = formatUnits(loanData.principal, USDC_DECIMALS);
            document.getElementById("interest").textContent = (Number(loanData.interestRate) / 100).toFixed(2);
            document.getElementById("collateral").textContent = Number(formatUnits(loanData.collateralAmount, COLLATERAL_DECIMALS)).toFixed(4);
            document.getElementById("payments-made").textContent = `${loanData.paymentsMade} / ${loanData.numPayments}`;

            document.getElementById("loan-disbursed").textContent = loanData.disbursed ? 'Active' : 'Pending';
            document.getElementById("loan-disbursed").className = loanData.disbursed
                ? 'font-semibold text-success'
                : 'font-semibold text-yellow-500';

            document.getElementById("time-remaining").textContent =
                timeRemaining(loanData.startTime, loanData.loanDuration, loanData.disbursed);

            document.getElementById("next-payment-due").textContent =
                nextPaymentDue(loanData.startTime, loanData.quarterly, loanData.paymentsMade, loanData.numPayments, loanData.disbursed);

            document.getElementById("borrower-dao-owner").textContent = formatAddress(loanData.borrowerOwner);
            document.getElementById("lender-dao-admin").textContent = formatAddress(loanData.lenderAdmin);
            document.getElementById("borrower-dao-addr").textContent = loanData.borrowerDAOAddr;
            document.getElementById("lender-dao-addr").textContent = loanData.lenderDAOAddr;
            
            document.getElementById("usdc-addr").textContent = loanData.usdcAddr;
            document.getElementById("collateral-token-addr").textContent = loanData.collateralTokenAddr;
            document.getElementById("loan-contract-addr").textContent = loanAddress;

            document.getElementById("borrower-balance").textContent =
                Number(formatUnits(loanData.borrowerBalance, USDC_DECIMALS)).toFixed(2) + " USDC";
            document.getElementById("lender-balance").textContent =
                Number(formatUnits(loanData.lenderBalance, USDC_DECIMALS)).toFixed(2) + " USDC";
            document.getElementById("loan-balance").textContent =
                Number(formatUnits(loanData.loanBalance, USDC_DECIMALS)).toFixed(2) + " USDC";
            document.getElementById("borrower-collateral-balance").textContent =
                Number(formatUnits(loanData.borrowerCollateralBalance, COLLATERAL_DECIMALS)).toFixed(4) + " DAO";
            document.getElementById("usdc-allowance").textContent =
                Number(formatUnits(loanData.usdcAllowance, USDC_DECIMALS)).toFixed(2) + " USDC";
            document.getElementById("collateral-allowance").textContent =
                Number(formatUnits(loanData.collateralAllowance, COLLATERAL_DECIMALS)).toFixed(4) + " DAO";
        }

        function updateActionButtons() {
            const container = document.getElementById('buttons-container');
            container.innerHTML = '';

            const role = loanData.role;
            const disbursed = loanData.disbursed;
            const paymentsMade = loanData.paymentsMade;
            const numPayments = loanData.numPayments;

            const collateralApproved = loanData.collateralAllowance >= loanData.collateralAmount;
            const requiredUSDCAllowance = (loanData.principal * 150n) / 100n;
            const isUSDCApproved = loanData.usdcAllowance >= requiredUSDCAllowance;
            const lenderHasUSDC = loanData.lenderDAOBalance >= loanData.principal;
            
            // Check if loan is completed (collateral returned to borrower = principal was repaid)
            const collateralInLoanContract = loanData.loanBalance > 0n || 
                                            (loanData.borrowerCollateralBalance >= loanData.collateralAmount && 
                                             disbursed && paymentsMade === numPayments);
            const loanCompleted = disbursed && loanData.principalRepaid && paymentsMade === numPayments;

            const addButton = (text, onClick, isEnabled = true, colorClass = 'bg-accent hover:bg-accent-hover') => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.onclick = onClick;
                btn.className = `transition-all px-4 py-2 rounded-lg font-semibold text-sm shadow-lg w-full md:w-auto flex-grow ${
                    isEnabled ? colorClass : 'bg-gray-600 cursor-not-allowed'
                }`;
                if (!isEnabled) btn.disabled = true;
                container.appendChild(btn);
            };

            addButton('Refresh', refreshStatus, true, 'bg-gray-600 hover:bg-gray-500');

            if (role === 'Borrower Admin') {
                if (!disbursed) {
                    if (!collateralApproved) {
                        addButton('1. Approve Collateral', approveCollateral, true);
                    } else {
                        addButton('✓ Collateral Approved', () => {}, false, 'bg-success/50');
                    }

                    if (!isUSDCApproved) {
                        addButton('2. Approve USDC', approveUSDC, true);
                    } else {
                        addButton('✓ USDC Approved', () => {}, false, 'bg-success/50');
                    }
                } else {
                    // Check if loan is completed
                    if (loanCompleted) {
                        addButton('✓ Loan Completed', () => {}, false, 'bg-success/50');
                    } else if (paymentsMade < numPayments) {
                        addButton(`Pay Q${paymentsMade + 1} Interest`, payInterest, true);
                    } else {
                        addButton('Repay Principal', repayPrincipal, true, 'bg-yellow-600 hover:bg-yellow-700');
                    }
                }
            }
            
            if (role === 'Lender Admin') {
                if (!disbursed) {
                    const canFund = collateralApproved && lenderHasUSDC;
                    addButton('3. Fund Loan', fundLoan, canFund);
                    
                    if (!collateralApproved) {
                        addButton('⏳ Awaiting Collateral', () => {}, false);
                    } else if (!lenderHasUSDC) {
                        addButton('⚠ LenderDAO Needs USDC', () => {}, false);
                    }
                } else {
                    const now = BigInt(Math.floor(Date.now() / 1000));
                    const expired = now > loanData.startTime + loanData.loanDuration;
                    
                    // Check if loan is completed
                    if (loanCompleted) {
                        addButton('✓ Loan Repaid Successfully', () => {}, false, 'bg-success/50');
                    } else if (expired && (paymentsMade < numPayments || !loanData.principalRepaid)) {
                        addButton('Claim Collateral (Default)', claimCollateral, true, 'bg-red-600 hover:bg-red-700');
                    } else {
                        addButton('Loan Active', () => {}, false);
                    }
                }
            }
        }
        
        async function executeTransaction(txFunction, successMessage) {
            if (!signer) return setTxMessage("Connect wallet.", 'error');
            setTxMessage("Pending...", 'info');
            try {
                const tx = await txFunction();
                setTxMessage(`Submitted: ${formatAddress(tx.hash)}`, 'info');
                await tx.wait();
                setTxMessage(successMessage, 'success');
                await refreshStatus();
            } catch (error) {
                console.error(error);
                let msg = "Transaction failed.";
                if (error.reason) msg = error.reason;
                else if (error.message && error.message.includes("user rejected")) msg = "User rejected transaction.";
                else if (error.data) msg = "Transaction reverted (check console)";
                setTxMessage(msg, 'error');
            }
        }

        // --- TX WRAPPERS ---

        const approveCollateral = () => executeTransaction(() => {
            return borrowerDAOContractInstance.approveLoanCollateral(
                loanAddress,
                loanData.collateralAmount
            );
        }, "Collateral Approved!");

        const approveUSDC = () => executeTransaction(() => {
            const maxAllowance = (loanData.principal * 150n) / 100n;
            return borrowerDAOContractInstance.approveToken(
                loanData.usdcAddr,
                loanAddress,
                maxAllowance
            );
        }, "USDC Approved!");

        const fundLoan = async () => {
            if (!signer) return setTxMessage("Connect wallet.", 'error');
            setTxMessage("Step 1/2: Transferring USDC to loan contract...", 'info');
            
            try {
                const transferTx = await lenderDAOContractInstance.transferTokens(
                    loanData.usdcAddr,
                    loanAddress,
                    loanData.principal
                );
                setTxMessage(`USDC transfer submitted: ${formatAddress(transferTx.hash)}`, 'info');
                await transferTx.wait();
                
                setTxMessage("Step 2/2: Funding loan...", 'info');
                
                const data = loanContract.interface.encodeFunctionData("fundLoan", []);
                const fundTx = await lenderDAOContractInstance.executeLoan(loanAddress, data);
                setTxMessage(`Fund loan submitted: ${formatAddress(fundTx.hash)}`, 'info');
                await fundTx.wait();
                
                setTxMessage("Loan Funded Successfully!", 'success');
                await refreshStatus();
            } catch (error) {
                console.error(error);
                let msg = "Failed to fund loan.";
                if (error.reason) msg = error.reason;
                else if (error.message && error.message.includes("user rejected")) msg = "User rejected transaction.";
                else if (error.data) msg = "Transaction reverted (check console)";
                setTxMessage(msg, 'error');
            }
        };

        const payInterest = () => executeTransaction(() => {
            const data = loanContract.interface.encodeFunctionData("payInterest", []);
            return borrowerDAOContractInstance.executeLoanAction(loanAddress, data);
        }, "Interest Paid!");

        const repayPrincipal = () => executeTransaction(() => {
            const data = loanContract.interface.encodeFunctionData("repayPrincipal", []);
            return borrowerDAOContractInstance.executeLoanAction(loanAddress, data);
        }, "Principal Repaid!");

        const claimCollateral = () => executeTransaction(() => {
            const data = loanContract.interface.encodeFunctionData("claimCollateral", []);
            return lenderDAOContractInstance.executeLoan(loanAddress, data);
        }, "Collateral Claimed!");

        window.onload = () => {
            if (window.ethereum) {
                connectWallet();
                window.ethereum.on('accountsChanged', connectWallet);
                window.ethereum.on('chainChanged', connectWallet);
            }
        };
    </script>
</body>
</html>
